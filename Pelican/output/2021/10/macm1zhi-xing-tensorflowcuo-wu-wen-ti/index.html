<!DOCTYPE html>
<html lang="zh_tw">
<head>
          <title>Richard隨手筆記</title>
        <meta charset="utf-8" />
        <link href="https://richardrobot.xyz/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Richard隨手筆記 Full Atom Feed" />
        <link href="https://richardrobot.xyz/feeds/category.slug.atom.xml" type="application/atom+xml" rel="alternate" title="Richard隨手筆記 Categories Atom Feed" />


    <meta name="tags" content="Tensorflow" />

        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <!--[if lte IE 8]><script src="/theme/js/ie/html5shiv.js"></script><![endif]-->
        <!--[if lte IE 8]><link rel="stylesheet" href="/theme/css/ie8.css" /><![endif]-->
</head>

<body>
        <header id="banner" class="body">
                <h1><a href="https://richardrobot.xyz/">Richard隨手筆記 <strong>紙上得來終覺淺，絕知此事要躬行</strong></a></h1>
        </header><!-- /#banner -->
<!-- Sidebar -->
            <div id="sidebar">

                <!-- Logo -->
                    <h1 id="logo"><a href="/">Richard隨手筆記</a></h1>
                    <!-- Text -->
                    <section class="box text-style1">
                        <div class="inner">
                            <p>
                                <strong>Ut scelerisque nec sapien ut sollicitudin:</strong><br />紙上得來終覺淺，絕知此事要躬行
                            </p>
                        </div>
                    </section>
                <!-- Nav -->
                    <nav id="nav">
                        <ul>
                            
                            <li><a href="#">Nam euismod dui</a></li>
                            <li><a href="#">Integer eget eros</a></li>
                            <li><a href="#">Proin vehicula tortor</a></li>
                            <li><a href="#">Vestibulum consectetur tellus</a></li>
                        </ul>
                    </nav>

                <!-- Search -->
                    <!-- <section class="box search">
                        <form method="post" action="#">
                            <input type="text" class="text" name="search" placeholder="Search" />
                        </form>
                    </section> -->

                

                <!-- Recent Posts -->
                    <section class="box recent-posts">
                        <header>
                            <h2>Contact Me</h2>
                        </header>
                        <ul>
                            <li><a class="icon fa-envelope" href="#"> eMail</a></li>
                            <li><a class="icon fa-twitter" href="#"> Twitter</a></li>
                            <li><a class="icon fa-facebook" href="#"> Facebook</a></li>
                            <li><a class="icon fa-github" href="#"> Github</a></li>
                            
                        </ul>
                    </section>



                <!-- Copyright -->
                    <ul id="copyright">
                        <li>Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.</li>
                        <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
                        <li>Modified under a <a href="https://creativecommons.org/licenses/by/3.0/">CC:BY</a> license.</li>
                    </ul>

            </div><!-- /#menu -->
<div id="content">
<div class="inner">
        <article class="box post post-excerpt">
                <header> 
                <h2><a href="https://richardrobot.xyz/2021/10/macm1zhi-xing-tensorflowcuo-wu-wen-ti/" rel="bookmark" title="Permalink to MacM1執行Tensorflow錯誤問題">MacM1執行Tensorflow錯誤問題</a></h2> 
                <p></p>
                </header>
                <div class="info">
                    <span class="date" datetime="2021-10-28T07:50:00+08:00"><span class="month">10</span> <span class="day">28</span> <span class="month"> 2021</span></span>
                    <ul class="stats">
                                    <li><a href="mailto:?Subject=MacM1執行Tensorflow錯誤問題&Body=I%20saw%20this%20and%20thought%20of%20you!%20 https://richardrobot.xyz/2021/10/macm1zhi-xing-tensorflowcuo-wu-wen-ti/" class="icon fa-envelope">&nbsp;</a></li>
                                    <li><a href="http://reddit.com/submit?url=https://richardrobot.xyz/2021/10/macm1zhi-xing-tensorflowcuo-wu-wen-ti/&title=#MacM1執行Tensorflow錯誤問題"" class="icon fa-reddit">&nbsp;</a></li>
                                    <li><a href="https://twitter.com/share?url=https://richardrobot.xyz/2021/10/macm1zhi-xing-tensorflowcuo-wu-wen-ti/&text=&hashtags=GnotC" class="icon fa-twitter">&nbsp;</a></li>
                                    <li><a href="https://www.facebook.com/sharer.php?u=https://richardrobot.xyz/2021/10/macm1zhi-xing-tensorflowcuo-wu-wen-ti/" class="icon fa-facebook">&nbsp;</a></li>
                                </ul>
                </div><!-- /.post-info -->
                <div class="entry-content"> &nbsp; </div><!-- /.entry-content -->
        </article>
    <p>每當執行如下的語法時：
<code>model.fit(x_train, y_train, epochs=5)</code></p>
<p>就會出現以下錯誤：</p>
<div class="highlight"><pre><span></span><code><span class="mi">2021</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">27</span> <span class="mi">20</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mf">06.945996</span><span class="p">:</span> <span class="n">I</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">mlir</span><span class="o">/</span><span class="n">mlir_graph_optimization_pass</span><span class="p">.</span><span class="na">cc</span><span class="p">:</span><span class="mi">185</span><span class="o">]</span> <span class="n">None</span> <span class="n">of</span> <span class="n">the</span> <span class="n">MLIR</span> <span class="n">Optimization</span> <span class="n">Passes</span> <span class="n">are</span> <span class="nf">enabled</span> <span class="p">(</span><span class="n">registered</span> <span class="mi">2</span><span class="p">)</span>

<span class="mi">2021</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">27</span> <span class="mi">20</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mf">06.948454</span><span class="p">:</span> <span class="n">W</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="n">profile_utils</span><span class="o">/</span><span class="n">cpu_utils</span><span class="p">.</span><span class="na">cc</span><span class="p">:</span><span class="mi">128</span><span class="o">]</span> <span class="n">Failed</span> <span class="n">to</span> <span class="n">get</span> <span class="n">CPU</span> <span class="n">frequency</span><span class="p">:</span> <span class="mi">0</span> <span class="n">Hz</span>

<span class="n">Epoch</span> <span class="mi">1</span><span class="o">/</span><span class="mi">5</span>

<span class="mi">2021</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">27</span> <span class="mi">20</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mf">07.052295</span><span class="p">:</span> <span class="n">I</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">grappler</span><span class="o">/</span><span class="n">optimizers</span><span class="o">/</span><span class="n">custom_graph_optimizer_registry</span><span class="p">.</span><span class="na">cc</span><span class="p">:</span><span class="mi">112</span><span class="o">]</span> <span class="n">Plugin</span> <span class="n">optimizer</span> <span class="k">for</span> <span class="n">device_type</span> <span class="n">GPU</span> <span class="n">is</span> <span class="n">enabled</span><span class="p">.</span>

<span class="mi">2021</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">27</span> <span class="mi">20</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mf">07.079</span> <span class="n">python</span><span class="o">[</span><span class="mi">8109</span><span class="p">:</span><span class="mi">118092</span><span class="o">]</span> <span class="o">-[</span><span class="n">MPSGraph</span> <span class="n">adamUpdateWithLearningRateTensor</span><span class="p">:</span><span class="n">beta1Tensor</span><span class="p">:</span><span class="n">beta2Tensor</span><span class="p">:</span><span class="n">epsilonTensor</span><span class="p">:</span><span class="n">beta1PowerTensor</span><span class="p">:</span><span class="n">beta2PowerTensor</span><span class="p">:</span><span class="n">valuesTensor</span><span class="p">:</span><span class="n">momentumTensor</span><span class="p">:</span><span class="n">velocityTensor</span><span class="p">:</span><span class="n">maximumVelocityTensor</span><span class="p">:</span><span class="n">gradientTensor</span><span class="p">:</span><span class="n">name</span><span class="p">:</span><span class="o">]</span><span class="p">:</span> <span class="n">unrecognized</span> <span class="n">selector</span> <span class="n">sent</span> <span class="n">to</span> <span class="n">instance</span> <span class="mh">0x29ee0f660</span>

<span class="mi">2021</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">27</span> <span class="mi">20</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mf">07.091</span> <span class="n">python</span><span class="o">[</span><span class="mi">8109</span><span class="p">:</span><span class="mi">118092</span><span class="o">]</span> <span class="o">***</span> <span class="n">Terminating</span> <span class="n">app</span> <span class="n">due</span> <span class="n">to</span> <span class="n">uncaught</span> <span class="n">exception</span> <span class="err">&#39;</span><span class="n">NSInvalidArgumentException</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="err">&#39;</span><span class="o">-[</span><span class="n">MPSGraph</span> <span class="n">adamUpdateWithLearningRateTensor</span><span class="p">:</span><span class="n">beta1Tensor</span><span class="p">:</span><span class="n">beta2Tensor</span><span class="p">:</span><span class="n">epsilonTensor</span><span class="p">:</span><span class="n">beta1PowerTensor</span><span class="p">:</span><span class="n">beta2PowerTensor</span><span class="p">:</span><span class="n">valuesTensor</span><span class="p">:</span><span class="n">momentumTensor</span><span class="p">:</span><span class="n">velocityTensor</span><span class="p">:</span><span class="n">maximumVelocityTensor</span><span class="p">:</span><span class="n">gradientTensor</span><span class="p">:</span><span class="n">name</span><span class="p">:</span><span class="o">]</span><span class="p">:</span> <span class="n">unrecognized</span> <span class="n">selector</span> <span class="n">sent</span> <span class="n">to</span> <span class="n">instance</span> <span class="mh">0x29ee0f660</span><span class="err">&#39;</span>
</code></pre></div>


<hr>
<p>一開始以爲是只能執行在Python 3.8的環境，但是參考教學 https://www.youtube.com/watch?v=_CO-<span class="caps">ND1FTOU</span></p>
<p>影片中也是能夠在Python3.9使用Tensorflow2.5，使用以下語法查看版本</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">tensorflow.keras</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sklearn</span> <span class="kn">as</span> <span class="nn">sk</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Tensor Flow Version: {tf.__version__}&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Keras Version: {tensorflow.keras.__version__}&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Python {sys.version}&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Pandas {pd.__version__}&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Scikit-Learn {sk.__version__}&quot;</span><span class="p">)</span>
<span class="n">gpu</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s1">&#39;GPU&#39;</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;GPU is&quot;</span><span class="p">,</span> <span class="s2">&quot;available&quot;</span> <span class="k">if</span> <span class="n">gpu</span> <span class="k">else</span> <span class="s2">&quot;NOT AVAILABLE&quot;</span><span class="p">)</span>
</code></pre></div>


<p>Tensor Flow Version: 2.6.0
Keras Version:&nbsp;2.6.0</p>
<p>Python 3.9.6 | packaged by conda-forge | (default, Jul 11 2021, 03:35:11) 
[Clang 11.1.0 ]
Pandas 1.3.0
Scikit-Learn 0.24.2
<span class="caps">GPU</span> is&nbsp;available</p>
<hr>
<p>用另外一個環境一樣Python3.9，TensorFlow2.5就可以正確執行，看來需要降版本，只好先移除了</p>
<p>安裝參考：
<a href="https://developer.apple.com/metal/tensorflow-plugin/">tensorflow-metal PluggableDevice&nbsp;入門</a></p>
<p><a href="https://makeoptim.com/deep-learning/tensorflow-metal"><span class="caps">AI</span> - Apple Silicon Mac M1 原生支持 TensorFlow 2.6 <span class="caps">GPU</span> 加速（tensorflow-metal&nbsp;PluggableDevice）</a></p>
<p>參考第二個連接的處理，重新安裝 Xcode&nbsp;，並且重新執行安裝語法就OK了</p>
<p>先解除安裝
<code>python -m pip uninstall tensorflow-macos</code></p>
<p><code>python -m pip uninstall tensorflow-metal</code></p>
<p>執行重新安裝
<code>conda install -c apple tensorflow-deps --force-reinstall</code></p>
<p><code>python -m pip install tensorflow-macos</code></p>
<p><code>python -m pip install tensorflow-metal</code></p>
<p>測試語法：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">models</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">tensorflow.keras.datasets</span> <span class="kn">import</span> <span class="n">mnist</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span>
<span class="p">(</span><span class="n">train_images</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">),</span> <span class="p">(</span><span class="n">test_images</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
<span class="n">train_images</span> <span class="o">=</span> <span class="n">train_images</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">60000</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">train_images</span> <span class="o">=</span> <span class="n">train_images</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span>
<span class="n">test_images</span> <span class="o">=</span> <span class="n">test_images</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">test_images</span> <span class="o">=</span> <span class="n">test_images</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span>
<span class="n">train_labels</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">train_labels</span><span class="p">)</span>
<span class="n">test_labels</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">test_labels</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;rmsprop&#39;</span><span class="p">,</span>
              <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_images</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<span class="n">test_loss</span><span class="p">,</span> <span class="n">test_acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_images</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span>
<span class="n">test_acc</span>
</code></pre></div>


<p>上面處理已經完成但是會引發一個問題：</p>
<p>numpy&nbsp;會被安裝成0.19的版本，而且會造成錯誤：</p>
<div class="highlight"><pre><span></span><code><span class="nl">ValueError:</span>
<span class="n">numpy</span><span class="p">.</span><span class="na">ndarray</span> <span class="n">size</span> <span class="n">changed</span><span class="p">,</span> <span class="n">may</span> <span class="n">indicate</span> <span class="n">binary</span> <span class="n">incompatibility</span><span class="p">.</span> <span class="n">Expected</span> <span class="mi">88</span> <span class="n">from</span> <span class="n">C</span> <span class="n">header</span><span class="p">,</span> <span class="n">got</span> <span class="mi">80</span> <span class="n">from</span> <span class="n">PyObject</span>
</code></pre></div>


<p>需要再更新Numpy</p>
<div class="highlight"><pre><span></span><code><span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="n">numpy</span>
</code></pre></div>
  </div><!-- /.entry-content -->
  <!-- Pagination -->
            <div class="pagination">
              <a class="button previous" href="https://richardrobot.xyz/2021/10/ben-yi-bi/">
             本益比
         </a>
              <a href="https://richardrobot.xyz/2021/11/shi-yong-bokehchan-sheng-ji-shu-tu-biao/" class="button next">使用Bokeh產生技術圖表</a>
            </div>
 
</div>
</div>
<!-- /#contentinfo -->
</body>
</html>