---
title: 12.DI 容器
date: 2022-04-13 14:03
modified: 2022-04-13 14:03
tags: 標籤
category: 後端程式
slug: 自定義URL標籤
summary: 預覽標題
image: /images/default_preview_image.jpg
status: draft
---

[TOC]

## 定義

>所謂的DI容器指的是一套軟體函式庫可提供DI架構中所需的功能，以及將一些如物件組合、攔截、生命週期管理之類的作業加以自動化的輔助功能。簡單說：一份幫助你解析、以及管理物件關聯的驅動引擎。

DI容器的原理其實就是透過反映（reflection）技術然後在去依照註冊的實體物件去產生實體，產生實體的方法就是：`Activator.CreateInstance`，通常透過兩個步驟：
1.註冊需要使用的依賴實體
2.呼叫遞迴產生實體的方法

通常使用註冊的方式寫法：`Register(Type serviceType,Type componetType)` 或是用泛型註冊：
`Register(Type serviceType,Func<object> factory)`

然後呼叫產生實體方法：`object Resolve(Type serviceType);` 或是用泛型：`T Resolve<T>();`

![[DI容器原理.jpg]]
## 自動裝配

使用一個簡單DI容器範例說明：

```c#
public class AutoWireContainer
{
	Dictonary<Type,Func<object>> registrations = new Dictonary<Type,Func<object>>();

	//註冊方法一：一般註冊
	public void Register(Type serviceType,Type componetType)
	{
		this.registrations[serviceType] = () => this.CreateNew(componetType);
	}
	//註冊方法二：泛型註冊
	public void Register(Type serviceType,Func<object> factory)
	{
		this.registrations[serviceType] = factory;
	}

	//呼叫遞迴產生實體的方法
	public object Resolve(Type type)
	{
		if(this.registrations.ContainsKey(type))
		{
			return this.registrations[type]();
		}
		throw new InvalidOperationException("No registration for");
	}


	//上面CreateNew的私有方法
	private object CreateNew(Type componetType)
	{
		var ctor = componetType.GetConstructors()[0];

		var dependencies = 
				from p in ctor.GetParameters()
				select this.Resolve(p.ParameterType);//遞迴處理建構子的參數物件
		//建立實體	
		return Activator.CreateInstance(componetType,dependecies.ToArray());
	}
}

```


上面範例程式DI容器原理，下面就是容器如何呼叫的寫法：

```c#
var container = new AutoWireContainer();

container.Register(typeof(IUserContext),typeof(AspNetUserContextAdapter));

container.Register(typeof(IProductRepository),typeof(SqlProductRepository));

container.Register(typeof(IProductService),typeof(ProductService));

container.Register(typeof(HomeController),typeof(HomeController));

//手工用new產生實體，因爲參數是String（詳細說明：P.468）
container.Register(typeof(CommerceContext),() => new CommerceContext(connectionString));


//最後執行呼叫建立
object controller = container.Resolve(typeof(HomeController));

```


## 設定DI容器

設定DI容器的方式：設定檔、程式化設定、自動註冊

| 方式       | 說明                                                                                                                           | 優點                                                               | 缺點                                                         |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------ |:------------------------------------------------------------ |
| 設定檔     | 對映關係是編寫在一個設定檔中（通常是XML或JSON）                                                                                | 不用重新編譯就可以修改替換                                         | 1.沒有辦法以編譯器協助確認正確性2.設定內容容易冗長且容易出錯 |
| 程式化設定 | 指的是可以把對容器的設定內容以原始碼的形式呈現。每組抽象介面與實體類別之間的對映關係，都是直接且明確的在程式碼中定義出來       | 1.可於編譯期輔助確認正確性2.可控制性高                             | 必須重新編譯才能進行修改或變更                               |
| 自動註冊   | 指的是根據一定規則，在一到多個組件檔中進行掃描，尋找抽象介面對映的實體類別，以此達到元件對映關係的自動註冊（通常使用反映技術） | 1.不用重新編譯2.設定所需要心力較少3.迫使開發者妥善維持程式對映關係 | 1.沒辦法以編譯器協助確認正確性2.可控制性低3.剛開始較難理解                                                             |


書中建議：使用自動註冊、程式化設定 爲主，避免使用設定檔

![[DI容器設定關係.jpg]]