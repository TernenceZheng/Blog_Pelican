---
title: 判斷使用者是否按上一頁
date: 2022-06-09 14:54
modified: 2022-06-09 14:54
tags: 標籤
category: 後網路概論
slug: 自定義URL標籤
summary: 預覽標題
image: /images/default_preview_image.jpg
status: draft
---

[TOC]

功能需求：要在GET頁面時，就判斷是否已經搶訂成功

問題：使用者按瀏覽器上一頁，因為快取沒有Reload頁面導致判斷失效

瀏覽器的上一頁會有個功能：[Back/forward cache](https://web.dev/bfcache/)

>引用：
>The "cache" used by bfcache is different from the [HTTP cache](https://web.dev/http-cache/) (which is also useful in speeding up repeat navigations). The bfcache is a snapshot of the entire page in memory (including the JavaScript heap), whereas the HTTP cache contains only the responses for previously made requests.

bfcache 與 HTTP cache 是不同的東西，bfcache是一整個頁面的快照，包含了JavaScript，而 HTTP 緩存僅包含對先前發出的請求的響應。一開始還想說加`no-cache` ，果然沒有用。

```html
<!-- HTTP 1.1 -->  
<meta http-equiv="Cache-Control" content="no-cache"/>
```


要判斷解決GET頁面是否從bfcache快照產生的，在API中有個事件`window.onpageshow` 事件中有個屬性 `persisted` 值為 True 或 False ，如下寫法可以判斷是bfcache快照然後就執行 `location.reload()`  

```javascript
window.onpageshow = function(event) {  
	if (event.persisted) {  
	window.location.reload()  
	}  
};
```

但是後來發現還是不行，在chrome 跟 Edge 中，event.persisted 總是為 false ，後參考文章[JavaScript - bfcache/pageshow 事件 - event.persisted 總是設置為 false](https://stackoverflow.com/questions/17432899/javascript-bfcache-pageshow-event-event-persisted-always-set-to-false)


改寫：多增加 `window.performance.navigation.type == 2`

```javascript
if (document.addEventListener) {
    window.addEventListener('pageshow', function (event) {
        if (event.persisted || window.performance && 
            window.performance.navigation.type == 2) 
        {
            location.reload();
        }
    },
   false);
}
```



參考資料：

[回到上一頁沒有reload](https://medium.com/@lemonchen/%E5%9B%9E%E5%88%B0%E4%B8%8A%E4%B8%80%E9%A0%81%E6%B2%92%E6%9C%89reload-ce6f42857967)

[JavaScript - bfcache/pageshow 事件 - event.persisted 總是設置為 false](https://stackoverflow.com/questions/17432899/javascript-bfcache-pageshow-event-event-persisted-always-set-to-false)

[Back/forward cache](https://web.dev/bfcache/)